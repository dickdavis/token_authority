# frozen_string_literal: true

class CreateTokenAuthorityTables < ActiveRecord::Migration<%= migration_version %>
  def change
    # OAuth Clients - registered applications that can request tokens
    create_table :token_authority_clients do |t|
      t.string :public_id, null: false # Public-facing identifier (UUID)
      t.string :name, null: false
      t.string :client_type, null: false, default: "confidential" # "confidential" or "public"
      t.json :redirect_uris, null: false # Array of redirect URIs
      t.bigint :access_token_duration, null: false
      t.bigint :refresh_token_duration, null: false
      t.string :client_secret_id # Used for HMAC-based secret generation (confidential clients only)

      # RFC 7591 client metadata
      t.string :token_endpoint_auth_method, null: false, default: "client_secret_basic"
      t.json :grant_types                  # Array, default: ["authorization_code"]
      t.json :response_types               # Array, default: ["code"]
      t.string :scope                      # space-delimited scope string

      # Human-readable metadata
      t.string :client_uri
      t.string :logo_uri
      t.string :tos_uri
      t.string :policy_uri
      t.json :contacts                     # Array of email addresses

      # Technical metadata (for JWT auth methods)
      t.string :jwks_uri
      t.json :jwks                         # JWKS object (inline)
      t.string :software_id
      t.string :software_version
      t.text :software_statement           # Original software statement JWT (if provided)

      # Registration metadata
      t.datetime :client_id_issued_at
      t.datetime :client_secret_expires_at
      t.boolean :dynamically_registered, null: false, default: false

      t.timestamps
    end

    add_index :token_authority_clients, :public_id, unique: true
    add_index :token_authority_clients, :client_secret_id, unique: true
    add_index :token_authority_clients, :software_id

    # Authorization Grants - authorization codes issued during OAuth flow
    create_table :token_authority_authorization_grants do |t|
      t.string :public_id, null: false # Public-facing identifier (UUID) - this is the authorization code
      t.datetime :expires_at, null: false
      t.boolean :redeemed, null: false, default: false
      t.references :token_authority_client,
        null: true, # Nullable for URL-based clients (Client Metadata Document)
        foreign_key: { to_table: :token_authority_clients },
        index: { name: "index_ta_auth_grants_on_client_id" }
      t.string :client_id_url # URL for URL-based client IDs (Client Metadata Document)
      t.<%= user_foreign_key_type %> :user_id

      t.timestamps
    end

    add_index :token_authority_authorization_grants, :public_id, unique: true
    add_index :token_authority_authorization_grants, :user_id, name: "index_ta_auth_grants_on_user_id"
    add_foreign_key :token_authority_authorization_grants, :<%= user_table_name %>, column: :user_id

    # PKCE Challenges - stores code_challenge for PKCE flow
    create_table :token_authority_challenges do |t|
      t.string :code_challenge
      t.string :code_challenge_method, default: "S256"
      t.string :redirect_uri
      t.references :token_authority_authorization_grant,
        null: false,
        foreign_key: { to_table: :token_authority_authorization_grants },
        index: { name: "index_ta_challenges_on_auth_grant_id" }

      t.timestamps
    end

    # OAuth Sessions - tracks issued tokens and their status
    create_table :token_authority_sessions do |t|
      t.string :access_token_jti, null: false
      t.string :refresh_token_jti, null: false
      t.string :status, null: false, default: "created" # "created", "expired", "refreshed", "revoked"
      t.references :token_authority_authorization_grant,
        null: true,
        foreign_key: { to_table: :token_authority_authorization_grants },
        index: { name: "index_ta_sessions_on_auth_grant_id" }

      t.timestamps
    end

    add_index :token_authority_sessions, :access_token_jti, unique: true
    add_index :token_authority_sessions, :refresh_token_jti, unique: true

    # JWKS Cache - stores fetched JWKS from remote URIs
    create_table :token_authority_jwks_caches do |t|
      t.string :uri_hash, null: false      # SHA256 hash of the URI for lookups
      t.string :uri, null: false           # Original URI for debugging/display
      t.json :jwks, null: false            # The cached JWKS data
      t.datetime :expires_at, null: false  # When this cache entry expires

      t.timestamps
    end

    add_index :token_authority_jwks_caches, :uri_hash, unique: true
    add_index :token_authority_jwks_caches, :expires_at

    # Client Metadata Document Cache - stores fetched metadata documents
    create_table :token_authority_client_metadata_document_caches do |t|
      t.string :uri_hash, null: false      # SHA256 hash of the URI for lookups
      t.string :uri, null: false           # Original URI for debugging/display
      t.json :metadata, null: false        # The cached metadata document
      t.datetime :expires_at, null: false  # When this cache entry expires

      t.timestamps
    end

    add_index :token_authority_client_metadata_document_caches, :uri_hash, unique: true, name: "index_ta_client_metadata_caches_on_uri_hash"
    add_index :token_authority_client_metadata_document_caches, :expires_at, name: "index_ta_client_metadata_caches_on_expires_at"
  end
end
